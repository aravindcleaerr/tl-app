<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TouchLog Hybrid</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- OCR & PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- FACE API (AI) -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; height: 100dvh; width: 100vw; overflow: hidden; position: fixed; }
        #root { height: 100%; width: 100%; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .scan-line {
            width: 100%; height: 4px; background: #4f46e5; position: absolute; top: 0; left: 0;
            box-shadow: 0 0 10px #4f46e5; animation: scan 1.5s linear infinite; display: none;
        }
        .scanning .scan-line { display: block; }
        @keyframes scan { 0% { top: 0; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        .fingerprint-path { fill: #cbd5e1; transition: fill 0.3s; }
        .scanning .fingerprint-path { fill: #818cf8; }
        .success .fingerprint-path { fill: #10b981; }

        .btn-press { transition: transform 0.1s; }
        .btn-press:active { transform: scale(0.95); }
        
        /* Video overlay for Face Scan */
        .video-container { position: relative; width: 100%; height: 250px; background: black; border-radius: 1rem; overflow: hidden; margin-bottom: 1rem; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .overlay-canvas { position: absolute; top: 0; left: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ADMIN_PIN = "1234"; 
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';

        const Icons = {
            Fingerprint: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z" opacity="0"/><path className="fingerprint-path" d="M17.81,4.43C16.19,3.2 14.18,2.5 12,2.5C9.82,2.5 7.81,3.2 6.19,4.43L7.6,5.84C8.85,4.92 10.36,4.5 12,4.5C13.64,4.5 15.15,4.92 16.4,5.84L17.81,4.43M12,19.5C10.36,19.5 8.85,18.96 7.6,18.04L6.19,19.46C7.81,20.68 9.82,21.5 12,21.5C14.18,21.5 16.19,20.68 17.81,19.46L16.4,18.04C15.15,18.96 13.64,19.5 12,19.5M12,7C9.24,7 7,9.24 7,12C7,13.1 7.37,14.1 8,14.9V12C8,9.79 9.79,8 12,8C14.21,8 16,9.79 16,12V14.9C16.63,14.1 17,13.1 17,12C17,9.24 14.76,7 12,7M12,10.5C11.17,10.5 10.5,11.17 10.5,12A1.5,1.5 0 0,0 12,13.5A1.5,1.5 0 0,0 13.5,12C13.5,11.17 12.83,10.5 12,10.5M19.5,12C19.5,14.07 18.66,15.94 17.31,17.29L18.73,18.7C20.44,17 21.5,14.63 21.5,12C21.5,9.37 20.44,7 18.73,5.3L17.31,6.71C18.66,8.06 19.5,9.93 19.5,12M4.5,12C4.5,9.93 5.34,8.06 6.69,6.71L5.27,5.3C3.56,7 2.5,9.37 2.5,12C2.5,14.63 3.56,17 5.27,18.7L6.69,17.29C5.34,15.94 4.5,14.07 4.5,12Z" /></svg>,
            Check: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            User: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            MapPin: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            Camera: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            History: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Cloud: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            ScanCard: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect x="7" y="7" width="10" height="8" rx="1"/></svg>,
            Building: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="21" width="18" height="2"></rect><path d="M5 21V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v14"></path><polyline points="8 21 8 12 16 12 16 21"></polyline></svg>,
            Face: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 20a6 6 0 0 0-12 0"/><path d="M9 10a1 1 0 1 0 0 2"/><path d="M15 10a1 1 0 1 0 0 2"/><path d="M9 3v2"/><path d="M15 3v2"/><path d="M12 3v2"/><circle cx="12" cy="12" r="9"/></svg>,
            UserPlus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>,
            Lock: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        };

        const Modal = ({ isOpen, title, message, type, onClose }) => {
            if (!isOpen) return null;
            const bg = type === 'success' ? 'bg-emerald-500' : type === 'info' ? 'bg-blue-500' : 'bg-rose-500';
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-xs shadow-2xl overflow-hidden transform transition-all">
                        <div className={`${bg} p-4 flex justify-center`}>
                            {type === 'success' ? <Icons.Check className="w-10 h-10 text-white"/> : type === 'info' ? <div className="animate-spin w-8 h-8 border-4 border-white border-t-transparent rounded-full"></div> : <Icons.Fingerprint className="w-10 h-10 text-white"/>}
                        </div>
                        <div className="p-6 text-center">
                            <h3 className="text-lg font-bold text-slate-800 mb-2">{title}</h3>
                            <p className="text-sm text-slate-500 mb-6">{message}</p>
                            {type !== 'info' && <button onClick={onClose} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold active:scale-95 transition-transform">Okay</button>}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('scan');
            const [mode, setMode] = useState('IN');
            const [scanMethod, setScanMethod] = useState('TOUCH'); 
            const [empId, setEmpId] = useState('');
            const [scanning, setScanning] = useState(false);
            const [progress, setProgress] = useState(0);
            const [geo, setGeo] = useState(null);
            const [modal, setModal] = useState(null);
            const [history, setHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('att_history') || '[]'); } catch { return []; } });
            const [scriptUrl, setScriptUrl] = useState(localStorage.getItem('att_script_url') || '');
            const [orgName, setOrgName] = useState(localStorage.getItem('att_org_name') || '');
            const [pinInput, setPinInput] = useState('');
            const [targetView, setTargetView] = useState(''); // Where to go after PIN
            const [isManaged, setIsManaged] = useState(false);
            const [modelsLoaded, setModelsLoaded] = useState(false);
            const [videoStream, setVideoStream] = useState(null);
            const [faceMatcher, setFaceMatcher] = useState(null);
            const [enrolledFaces, setEnrolledFaces] = useState(() => { try { return JSON.parse(localStorage.getItem('att_faces') || '{}'); } catch { return {}; } });
            const [enrolledPrints, setEnrolledPrints] = useState(() => { try { return JSON.parse(localStorage.getItem('att_prints') || '{}'); } catch { return {}; } });

            const videoRef = useRef(null);
            const idCardInputRef = useRef(null);
            const timerRef = useRef(null);

            // SAVE EFFECTS
            useEffect(() => { localStorage.setItem('att_history', JSON.stringify(history)); }, [history]);
            useEffect(() => { if(!isManaged) localStorage.setItem('att_script_url', scriptUrl); }, [scriptUrl]);
            useEffect(() => { if(!isManaged) localStorage.setItem('att_org_name', orgName); }, [orgName]);
            useEffect(() => { localStorage.setItem('att_faces', JSON.stringify(enrolledFaces)); }, [enrolledFaces]);
            useEffect(() => { localStorage.setItem('att_prints', JSON.stringify(enrolledPrints)); }, [enrolledPrints]);

            // LOAD MODELS
            useEffect(() => {
                const loadAI = async () => {
                    try {
                        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                        setModelsLoaded(true);
                        console.log("AI Models Loaded");
                    } catch (e) { console.error("AI Error", e); }
                };
                loadAI();
            }, []);

            // INIT FACE MATCHER
            useEffect(() => {
                if(modelsLoaded && Object.keys(enrolledFaces).length > 0) {
                    const labeledDescriptors = Object.keys(enrolledFaces).map(id => {
                        const descriptor = new Float32Array(Object.values(enrolledFaces[id]));
                        return new faceapi.LabeledFaceDescriptors(id, [descriptor]);
                    });
                    setFaceMatcher(new faceapi.FaceMatcher(labeledDescriptors, 0.6));
                }
            }, [modelsLoaded, enrolledFaces]);

            // AUTO SYNC & GPS
            useEffect(() => {
                const interval = setInterval(() => {
                    const pending = history.filter(h => h.syncStatus === 'pending');
                    if(pending.length > 0 && navigator.onLine && scriptUrl) syncData(pending[0]);
                }, 5000);
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((pos) => setGeo({ lat: pos.coords.latitude, lng: pos.coords.longitude }));
                }
                return () => clearInterval(interval);
            }, [history, scriptUrl]);

            const syncData = async (item) => {
                try {
                    await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(item) });
                    setHistory(prev => prev.map(h => h.id === item.id ? { ...h, syncStatus: 'synced' } : h));
                } catch(e) { }
            };

            // ---- SHARED CAMERA LOGIC ----
            const startVideo = async () => {
                if(!modelsLoaded) { setModal({ title: 'Loading AI', message: 'Please wait...', type: 'info' }); return false; }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    setVideoStream(stream);
                    if(videoRef.current) videoRef.current.srcObject = stream;
                    return true;
                } catch(err) {
                    setModal({ title: 'Camera Error', message: 'Permission denied.', type: 'error' });
                    return false;
                }
            };

            const stopVideo = () => {
                if(videoStream) { videoStream.getTracks().forEach(track => track.stop()); setVideoStream(null); }
            };

            // ---- ENROLLMENT LOGIC ----
            const enrollFace = async () => {
                if(!empId) return setModal({ title: 'Missing ID', message: 'Enter ID to enroll.', type: 'error' });
                const started = await startVideo();
                if(started) setScanning('enroll_face'); // Special mode to show capture button
            };

            const captureEnrollmentFace = async () => {
                if(!videoRef.current) return;
                const detections = await faceapi.detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                
                if(detections) {
                    setEnrolledFaces(prev => ({ ...prev, [empId]: Array.from(detections.descriptor) }));
                    stopVideo();
                    setScanning(false);
                    setModal({ title: 'Face Enrolled!', message: `User ${empId} registered.`, type: 'success' });
                } else {
                    setModal({ title: 'No Face Found', message: 'Ensure face is clearly visible.', type: 'error' });
                }
            };

            const enrollFingerprint = () => {
                if(!empId) return setModal({ title: 'Missing ID', message: 'Enter ID to enroll.', type: 'error' });
                setScanning('enroll_touch');
                setProgress(0);
                let p = 0;
                timerRef.current = setInterval(() => {
                    p += 2; // Slower for enrollment (more deliberate)
                    setProgress(p);
                    if(p >= 100) {
                        clearInterval(timerRef.current);
                        setScanning(false);
                        setEnrolledPrints(prev => ({ ...prev, [empId]: true }));
                        setModal({ title: 'Print Enrolled!', message: `Fingerprint registered for ${empId}`, type: 'success' });
                    }
                }, 50);
            };

            const cancelEnrollment = () => {
                clearInterval(timerRef.current);
                stopVideo();
                setScanning(false);
                setProgress(0);
            };

            // ---- ATTENDANCE SCAN LOGIC ----
            const handleFaceScan = async () => {
                if(!validateScan()) return;
                if(!enrolledFaces[empId]) return setModal({ title: 'Not Enrolled', message: 'No Face ID found for this user.', type: 'error' });

                setScanning('scan_face');
                await startVideo();

                let attempts = 0;
                const checkFace = async () => {
                    if(!videoRef.current || !videoStream) return;
                    attempts++;
                    const descriptor = await getFaceDescriptor();
                    
                    if(descriptor && faceMatcher) {
                        const bestMatch = faceMatcher.findBestMatch(descriptor);
                        if(bestMatch.label === empId) {
                            stopVideo();
                            setScanning(false);
                            completeAttendance("Face Verified");
                            return;
                        }
                    }

                    if(attempts < 15) setTimeout(checkFace, 300); 
                    else {
                        stopVideo();
                        setScanning(false);
                        setModal({ title: 'Verification Failed', message: 'Face does not match ID.', type: 'error' });
                    }
                };
                setTimeout(checkFace, 1000); 
            };

            const getFaceDescriptor = async () => {
                if(!videoRef.current) return null;
                const detections = await faceapi.detectSingleFace(videoRef.current, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                return detections ? detections.descriptor : null;
            };

            const handleTouchScan = () => {
                if(!validateScan()) return;
                if(!enrolledPrints[empId]) return setModal({ title: 'Not Enrolled', message: 'No Fingerprint registered for this user.', type: 'error' });

                setScanning('scan_touch');
                setProgress(0);
                let p = 0;
                timerRef.current = setInterval(() => {
                    p += 5; 
                    setProgress(p);
                    if(p >= 100) {
                        clearInterval(timerRef.current);
                        setScanning(false);
                        completeAttendance("Touch (Rapid)");
                    }
                }, 50);
            };

            const validateScan = () => {
                if(!empId) { setModal({ title: 'Missing ID', message: 'Enter Employee ID.', type: 'error' }); return false; }
                if(!orgName) { setModal({ title: 'Setup Required', message: 'Configure Organization Name.', type: 'error' }); return false; }
                return true;
            };

            const completeAttendance = (method) => {
                const newRecord = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    empId: empId,
                    type: mode,
                    orgName: orgName,
                    geo: geo ? `${geo.lat},${geo.lng}` : 'Unknown',
                    method: method,
                    syncStatus: 'pending'
                };
                setHistory([newRecord, ...history]);
                setModal({ title: 'Attendance Logged', message: `${empId} Checked ${mode}`, type: 'success' });
                setEmpId('');
            };

            const handleIDScan = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setModal({ title: 'Scanning ID...', message: 'Extracting text...', type: 'info' });
                try {
                    const worker = await Tesseract.createWorker('eng');
                    const ret = await worker.recognize(file);
                    await worker.terminate();
                    const text = ret.data.text;
                    const numbers = text.match(/\d{3,}/g);
                    if (numbers) {
                        setEmpId(numbers.sort((a, b) => b.length - a.length)[0]);
                        setModal({ title: 'ID Detected', message: `Found ID`, type: 'success' });
                    } else setModal({ title: 'Scan Failed', message: 'Enter manually.', type: 'error' });
                } catch (err) { setModal({ title: 'Error', message: 'Failed to read image.', type: 'error' }); }
            };

            const handlePin = (val) => {
                const newPin = pinInput + val;
                if(newPin.length === 4) {
                    if(newPin === ADMIN_PIN) { 
                        setPinInput(''); 
                        setView(targetView); // Go to requested view (enroll or settings)
                        setTargetView('');
                    }
                    else { setModal({ title: 'Access Denied', message: 'Incorrect PIN', type: 'error' }); setPinInput(''); }
                } else { setPinInput(newPin); }
            };

            const reqPin = (v) => {
                setTargetView(v);
                setView('pin');
            };

            // --- VIEW: PIN ENTRY ---
            if (view === 'pin') {
                return (
                    <div className="flex items-center justify-center h-full bg-slate-900 text-white p-6">
                        <div className="w-full max-w-xs">
                            <h2 className="text-2xl font-bold mb-6 text-center">Admin Access</h2>
                            <div className="flex justify-center gap-4 mb-8">
                                {[0,1,2,3].map(i => <div key={i} className={`w-4 h-4 rounded-full ${i < pinInput.length ? 'bg-indigo-500' : 'bg-slate-700'}`}></div>)}
                            </div>
                            <div className="grid grid-cols-3 gap-4">
                                {[1,2,3,4,5,6,7,8,9,0].map(n => (<button key={n} onClick={() => handlePin(n.toString())} className="bg-slate-800 p-4 rounded-xl font-bold text-xl active:scale-95">{n}</button>))}
                                <button onClick={() => handlePin('*')} className="bg-slate-800 p-4 rounded-xl font-bold text-xl active:scale-95 text-indigo-400">*</button>
                                <button onClick={() => handlePin('#')} className="bg-slate-800 p-4 rounded-xl font-bold text-xl active:scale-95 text-indigo-400">#</button>
                            </div>
                            <button onClick={() => { setView('scan'); setPinInput(''); }} className="w-full mt-8 py-3 text-slate-400 font-bold">Cancel</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full bg-slate-50 max-w-md mx-auto shadow-2xl overflow-hidden relative">
                    <Modal isOpen={!!modal} title={modal?.title} message={modal?.message} type={modal?.type} onClose={() => setModal(null)} />
                    
                    {/* HEADER */}
                    <div className="bg-indigo-600 p-6 pt-10 text-white rounded-b-[2.5rem] shadow-lg shrink-0 relative z-10">
                        <div className="flex justify-between items-center mb-6">
                            <div><h1 className="text-2xl font-extrabold tracking-tight">TouchLog</h1><p className="text-indigo-200 text-xs font-medium uppercase">{orgName || "Configure App"}</p></div>
                            <div className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 ${geo ? 'bg-emerald-500/20 text-emerald-100' : 'bg-rose-500/20 text-rose-100'}`}> <Icons.MapPin className="w-3 h-3" /> {geo ? 'GPS' : 'No GPS'} </div>
                        </div>
                        <div className="bg-black/20 p-1.5 rounded-2xl flex relative"><div className={`absolute top-1.5 bottom-1.5 w-[calc(50%-6px)] bg-white rounded-xl shadow-md transition-all duration-300 ${mode === 'OUT' ? 'translate-x-full left-1.5' : 'left-1.5'}`}></div><button onClick={() => setMode('IN')} className={`flex-1 py-3 text-sm font-bold rounded-xl relative z-10 transition-colors ${mode === 'IN' ? 'text-indigo-700' : 'text-indigo-100'}`}>CHECK IN</button><button onClick={() => setMode('OUT')} className={`flex-1 py-3 text-sm font-bold rounded-xl relative z-10 transition-colors ${mode === 'OUT' ? 'text-indigo-700' : 'text-indigo-100'}`}>CHECK OUT</button></div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 pb-24">
                        {view === 'scan' && (
                            <div className="animate-fade-in flex flex-col h-full justify-between">
                                <div className="space-y-4">
                                    <div className="flex justify-center bg-white p-1 rounded-xl border border-slate-200 shadow-sm mx-auto max-w-[200px]">
                                        <button onClick={() => setScanMethod('TOUCH')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${scanMethod === 'TOUCH' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400'}`}><Icons.Fingerprint className="w-4 h-4"/> Touch</button>
                                        <button onClick={() => setScanMethod('FACE')} className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${scanMethod === 'FACE' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400'}`}><Icons.Face className="w-4 h-4"/> Face</button>
                                    </div>
                                    <div className="relative flex gap-2">
                                        <div className="relative flex-1">
                                            <div className="absolute inset-y-0 left-3 flex items-center pointer-events-none"><Icons.User className="w-5 h-5 text-slate-400" /></div>
                                            <input type="text" value={empId} onChange={(e) => setEmpId(e.target.value)} placeholder="Enter ID" className="w-full pl-10 pr-4 py-4 bg-white border border-slate-200 rounded-2xl font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"/>
                                        </div>
                                        <button onClick={() => idCardInputRef.current.click()} className="bg-indigo-50 border border-indigo-200 rounded-2xl px-4 flex flex-col items-center justify-center text-indigo-600 hover:bg-indigo-100"><Icons.ScanCard className="w-6 h-6 mb-0.5" /><span className="text-[9px] font-bold uppercase">Scan ID</span></button>
                                        <input type="file" ref={idCardInputRef} accept="image/*" className="hidden" onChange={handleIDScan}/>
                                    </div>
                                </div>

                                <div className="flex-1 flex flex-col items-center justify-center py-4">
                                    {scanMethod === 'FACE' && (
                                        scanning === 'scan_face' ? (
                                            <div className="video-container"><video ref={videoRef} autoPlay muted playsInline></video><div className="scan-line" style={{display:'block'}}></div></div>
                                        ) : (
                                            <div className="relative w-48 h-48 rounded-full border-4 flex items-center justify-center bg-white shadow-xl transition-all duration-300 btn-press select-none cursor-pointer border-slate-100" onTouchStart={handleFaceScan} onMouseDown={handleFaceScan}>
                                                <div className="w-28 h-28 text-slate-300"><Icons.Face className="w-full h-full" /></div>
                                            </div>
                                        )
                                    )}
                                    {scanMethod === 'TOUCH' && (
                                        <div className={`relative w-48 h-48 rounded-full border-4 flex items-center justify-center bg-white shadow-xl overflow-hidden transition-all duration-300 btn-press select-none cursor-pointer ${scanning === 'scan_touch' ? 'border-indigo-500 scale-105' : 'border-slate-100'}`} onMouseDown={handleTouchScan} onMouseUp={cancelEnrollment} onMouseLeave={cancelEnrollment} onTouchStart={(e) => { e.preventDefault(); handleTouchScan(); }} onTouchEnd={cancelEnrollment}>
                                            <div className={`absolute bottom-0 left-0 right-0 bg-indigo-50 transition-all duration-75`} style={{height: `${progress}%`}}></div>
                                            <div className={`w-28 h-28 text-slate-300 relative z-10 ${scanning ? 'scanning' : ''}`}><div className="scan-line"></div><Icons.Fingerprint className="w-full h-full" /></div>
                                        </div>
                                    )}
                                    <p className="mt-6 text-slate-400 font-medium text-sm">{scanning ? 'Scanning...' : 'Verify Identity'}</p>
                                </div>
                            </div>
                        )}

                        {view === 'enroll' && (
                            <div className="animate-fade-in space-y-4">
                                <h2 className="font-bold text-slate-700 text-lg flex items-center gap-2"><Icons.UserPlus className="w-5 h-5"/> Enrollment Station</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">User ID</label>
                                    <input type="text" value={empId} onChange={e => setEmpId(e.target.value)} placeholder="EMP001" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold mb-6 focus:ring-2 focus:ring-indigo-500 outline-none"/>
                                    
                                    {scanning === 'enroll_face' ? (
                                        <div className="mb-4">
                                            <div className="video-container"><video ref={videoRef} autoPlay muted playsInline></video></div>
                                            <button onClick={captureEnrollmentFace} className="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold animate-pulse">Capture & Save Face</button>
                                        </div>
                                    ) : scanning === 'enroll_touch' ? (
                                        <div className="flex flex-col items-center mb-6">
                                            <div className="relative w-32 h-32 rounded-full border-4 border-indigo-500 flex items-center justify-center bg-white overflow-hidden" onMouseUp={cancelEnrollment} onTouchEnd={cancelEnrollment}>
                                                <div className={`absolute bottom-0 left-0 right-0 bg-indigo-50 transition-all duration-75`} style={{height: `${progress}%`}}></div>
                                                <Icons.Fingerprint className="w-16 h-16 text-indigo-500"/>
                                            </div>
                                            <p className="mt-2 text-indigo-500 font-bold text-xs">Hold to Register...</p>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={enrollFace} className="py-4 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm border border-indigo-100 flex flex-col items-center gap-2 hover:bg-indigo-100"><Icons.Face className="w-6 h-6"/> Enroll Face</button>
                                            <button onMouseDown={enrollFingerprint} onTouchStart={(e) => { e.preventDefault(); enrollFingerprint(); }} className="py-4 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm border border-indigo-100 flex flex-col items-center gap-2 hover:bg-indigo-100"><Icons.Fingerprint className="w-6 h-6"/> Enroll Print</button>
                                        </div>
                                    )}
                                    <div className="mt-6 pt-4 border-t border-slate-100">
                                        <p className="text-xs text-slate-400 mb-1">Status:</p>
                                        <div className="flex gap-2">
                                            <span className={`px-2 py-1 rounded text-[10px] font-bold ${enrolledFaces[empId] ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}`}>Face: {enrolledFaces[empId] ? 'Yes' : 'No'}</span>
                                            <span className={`px-2 py-1 rounded text-[10px] font-bold ${enrolledPrints[empId] ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}`}>Print: {enrolledPrints[empId] ? 'Yes' : 'No'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="animate-fade-in space-y-4">
                                <div className="flex justify-between items-center mb-2"><h2 className="font-bold text-slate-700">Today's Logs</h2></div>
                                {history.map(h => (
                                    <div key={h.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white text-xs ${h.type === 'IN' ? 'bg-indigo-500' : 'bg-slate-500'}`}>{h.type}</div>
                                            <div><div className="font-bold text-slate-800">ID: {h.empId}</div><div className="text-xs text-slate-400">{new Date(h.timestamp).toLocaleString()}</div></div>
                                        </div>
                                        <div className="text-[10px] px-2 py-1 rounded font-bold bg-slate-100 text-slate-600">{h.method}</div>
                                    </div>
                                ))}
                                <button onClick={() => { if(confirm('Clear all?')) setHistory([]) }} className="w-full py-4 text-rose-500 font-bold text-xs">Clear Local Data</button>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="animate-fade-in space-y-4">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                    <h3 className="font-bold text-slate-800 mb-4">App Config</h3>
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Org Name</label>
                                    <input type="text" value={orgName} onChange={(e) => setOrgName(e.target.value)} disabled={isManaged} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm font-bold mb-4" />
                                    <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Script URL</label>
                                    <input type="text" value={scriptUrl} onChange={(e) => setScriptUrl(e.target.value)} disabled={isManaged} className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-xs font-mono mb-4" />
                                    <button onClick={() => { setView('scan'); }} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Save & Exit</button>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="bg-white border-t border-slate-200 flex justify-around py-3 pb-safe absolute bottom-0 w-full">
                        <button onClick={() => setView('scan')} className={`p-2 rounded-xl transition-all ${view === 'scan' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400'}`}><Icons.Fingerprint className="w-6 h-6" /></button>
                        <button onClick={() => setView('history')} className={`p-2 rounded-xl transition-all ${view === 'history' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400'}`}><Icons.History className="w-6 h-6" /></button>
                        <button onClick={() => reqPin('enroll')} className={`p-2 rounded-xl transition-all ${view === 'enroll' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400'}`}><Icons.UserPlus className="w-6 h-6" /></button>
                        <button onClick={() => reqPin('settings')} className={`p-2 rounded-xl transition-all ${view === 'settings' ? 'bg-indigo-50 text-indigo-600' : 'text-slate-400'}`}><Icons.Lock className="w-6 h-6" /></button>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>